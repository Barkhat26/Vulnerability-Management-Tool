import requests
import os
import zipfile

CVE_FEEDS_DIR = 'cve_feeds'


def download_file(url):
    local_filename = url.split('/')[-1]
    # NOTE the stream=True parameter below
    with requests.get(url, stream=True) as r:
        r.raise_for_status()
        with open(os.path.join(CVE_FEEDS_DIR, local_filename), 'wb') as f:
            for chunk in r.iter_content(chunk_size=8192):
                if chunk:  # filter out keep-alive new chunks
                    f.write(chunk)
                    # f.flush()
    return local_filename


def main():
    if not os.path.exists(CVE_FEEDS_DIR): os.makedirs(CVE_FEEDS_DIR)

    urls = []
    years = ['2002', '2003', '2004',
             '2005', '2006', '2007', '2008', '2009', '2010',
             '2011', '2012', '2013', '2014', '2015', '2016',
             '2017', '2018', '2019', '2020']

    for year in years:
        urls.append('https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-%s.json.zip' % year)

    urls.append('https://nvd.nist.gov/feeds/json/cpematch/1.0/nvdcpematch-1.0.json.zip')

    for url in urls:
        filename = url.split('/')[-1]
        print('Downloading %s' % filename)
        download_file(url)
        print('Extracting %s' % filename)
        zipfile.ZipFile(os.path.join(CVE_FEEDS_DIR, filename)).extractall(CVE_FEEDS_DIR)


if __name__ == '__main__':
    main()